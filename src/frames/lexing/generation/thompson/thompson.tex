% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin
% Part: 
% Section: 
% Sub-section: 
% Frame: 

\begingroup

\SetKwFunction{Thompson}{thompson}
\SetKwData{Input}{motif}

\begin{frame}{Algorithme de Thompson}

  \tf[y=-3mm]{\footnotesize
    \begin{algorithm}[H]
      
      \Fn{\Thompson(\Input : \textsc{regex}, $\Sigma$ : alphabet) : automate}{
        \Lets \alert{$q_0$}, \alert{$q_f$} deux nouveaux Ã©tats\;
        \uSi{$\Input = \emptyset$}{
          \vspace{.5mm}
          \uncover<2-|handout>{
            $\begin{array}{@{}l@{\,\gets\,}l@{}}
              Q & \{\alert{q_0}, \alert{q_f}\};\\
              \tau & \emptyset;
            \end{array}$
          }
          \vspace{.5mm}
        }\uSinonSi{$\Input = a\in \Sigma \cup \{\varepsilon\}$}{
          \vspace{.5mm}
          \uncover<3-|handout>{
            $\begin{array}{@{}l@{\,\gets\,}l@{}}
              Q & \{\alert{q_0}, \alert{q_f}\};\\
              \tau & \left\{ \alert{\langle q_0, a, q_f \rangle} \right\};
            \end{array}$
          }
          \vspace{.5mm}
        }\uSinonSi{$\Input = u \mid v$}{
          \vspace{.5mm}
          \uncover<4-|handout>{
            $\langle \structure{\Sigma}, \structure{Q_u}, \{\structure{u_0}\}, \{\structure{u_f}\}, \structure{\tau_{u}} \rangle \gets \structure{\Thompson(u, \Sigma)}$\;
            $\langle \example{\Sigma}, \example{Q_v}, \{\example{v_0}\}, \{\example{v_f}\}, \example{\tau_{v}}\, \rangle \gets \example{\Thompson(v, \Sigma)}$\;
            $\begin{array}{@{}l@{\,\gets\,}c@{\,\cup\,}c@{\,\cup\,}l@{}}
              Q    & \structure{Q_u}    & \example{Q_v}    & \{\alert{q_0}, \alert{q_f}\};\\
              \tau & \structure{\tau_u} & \example{\tau_v} & \left\{
              \begin{array}{@{\alert{\langle}}c@{\alert{, \varepsilon,}\,}c@{\alert{\rangle}, \alert{\langle}}c@{\alert{, \varepsilon,}\,}c@{\alert{\rangle}}l@{}}
                \alert{q_0}&\alert{u_0}&\alert{q_0}&\alert{v_0}&,\\
                \alert{u_f}&\alert{q_f}&\alert{v_f}&\alert{q_f}&
              \end{array}\right\};
            \end{array}$
          }
          \vspace{.5mm}
        }\uSinonSi{$\Input = u \cdot v$}{
          \vspace{.5mm}
          \uncover<5-|handout>{
            $\langle \structure{\Sigma}, \structure{Q_u}, \{\structure{u_0}\}, \{\structure{u_f}\}, \structure{\tau_{u}} \rangle \gets \structure{\Thompson(u, \Sigma)}$\;
            $\langle \example{\Sigma}, \example{Q_v}, \{\example{v_0}\}, \{\example{v_f}\}, \example{\tau_{v}}\, \rangle \gets \example{\Thompson(v, \Sigma)}$\;
            $\begin{array}{@{}l@{\,\gets\,}l}
              Q & \structure{Q_u} \cup \example{Q_v} \setminus \{v_0\};\\
              q_0 & \structure{u_0};\,q_f \gets \example{v_f};\\
              \tau & \structure{\tau_u} \cup \example{\tau_v} \cup \left\{\alert{\langle u_f, \varepsilon, v_0\rangle}\right\}
            \end{array}$
          }
          \vspace{.5mm}
        }\SinonSi{$\Input = u^\star$}{
          \vspace{.5mm}
          \uncover<6-|handout>{
            $\langle \structure{\Sigma}, \structure{Q_u}, \{\structure{u_0}\}, \{\structure{u_f}\}, \structure{\tau_{u}} \rangle \gets \structure{\Thompson(u, \Sigma)}$\;
            $\begin{array}{@{}l@{\,\gets\,}c@{\,\cup\,}l@{}}
              Q & \structure{Q_u} & \{\alert{q_0}, \alert{q_f}\};\\
              \tau & \structure{\tau_u} & \left\{\alert{\langle q_0, \varepsilon, u_0\rangle}, \alert{\langle u_f, \varepsilon, u_0\rangle}, \alert{\langle u_f, \varepsilon, q_f\rangle}\right\}
            \end{array}$
          }
        }
        \Retourner $\langle \Sigma, Q, \{q_0\}, \{q_f\}, \tau \rangle$\;
      }
    \end{algorithm}
  }

  \tf<2-|handout>[x=-1cm, y=26mm]{\footnotesize
    \begin{tikzpicture}[smAutomaton]
      \smState[\smInitial \smAlert]   (a1) at (0.0,0) {$q_0$}; 
      \smState[\smAccepting \smAlert] (a2) at (1.5,0) {$q_f$}; 
    \end{tikzpicture}
  }

  \tf<3-|handout>[x=-1cm, y=15mm]{\footnotesize
    \begin{tikzpicture}[smAutomaton]
      \smState[\smInitial \smAlert]   (b1) at (0.0,0) {$q_0$}; 
      \smState[\smAccepting \smAlert] (b2) at (1.5,0) {$q_f$}; 

      \smPath[\smAlert] (b1) edge node{$a$} (b2); 
    \end{tikzpicture}
  }

  \tf<4-|handout>[y=22mm, x=5mm, anchor=west]{\footnotesize
    \begin{tikzpicture}[smAutomaton]
      \node[smCloud, fill=structure!12]  (c3) at (2.75,1.0) {};
      \node[smCloud, fill=example!12]    (c6) at (2.75,0.0) {};

      \smState [\smInitial\smAlert]   (c1) at (0.75,0.5) {$q_0$};
      \smState [\smStructure]         (c2) at (1.75,1.0) {$u_0$};
      \smState [\smStructure]         (c4) at (3.25,1.0) {$u_f$};
      \smState [\smExample  ]         (c5) at (1.75,0.0) {$v_0$};
      \smState [\smExample  ]         (c7) at (3.25,0.0) {$v_f$};
      \smState [\smAccepting\smAlert] (c8) at (4.25,0.5) {$q_f$};
      
      \smPath[\smAlert] (c1) edge node {$\varepsilon$} (c2);
      \smPath[\smAlert] (c1) edge node {$\varepsilon$} (c5);
      \smPath[\smAlert] (c4) edge node {$\varepsilon$} (c8);
      \smPath[\smAlert] (c7) edge node {$\varepsilon$} (c8);
      
      \path [-latex, dashed, structure!65] (c2) edge[bend left=5mm]  (c4);
      \path [-latex, dashed, structure!65] (c2) edge                 (c4);
      \path [-latex, dashed, structure!65] (c2) edge[bend right=5mm] (c4);
      \path [-latex, dashed, example!65]   (c5) edge[bend left=5mm]  (c7);
      \path [-latex, dashed, example!65]   (c5) edge                 (c7);
      \path [-latex, dashed, example!65]   (c5) edge[bend right=5mm] (c7);
    \end{tikzpicture}
  }
  
  \tf<5-|handout>[y=-6mm, x=5mm, anchor=west]{\footnotesize
    \begin{tikzpicture}[smAutomaton]
      \node[smCloud, fill=structure!12]  (d3) at (1.5,2.5) {};
      \node[smCloud, fill=example!12]    (d6) at (4.0,2.5) {};

      \smState [\smInitial \smStructure] (d2) at (0.5,2.5) {$u_0$};
      \smState [           \smStructure] (d4) at (2.0,2.5) {$u_f$};
      \smState [             \smExample] (d5) at (3.0,2.5) {$v_0$};
      \smState [\smAccepting \smExample] (d7) at (4.5,2.5) {$v_f$};
      
      \smPath[\smAlert] (d4) edge node {$\varepsilon$} (d5);
      
      \path [-latex, dashed, structure!65] (d2) edge[bend left=5mm]  (d4);
      \path [-latex, dashed, structure!65] (d2) edge                 (d4);
      \path [-latex, dashed, structure!65] (d2) edge[bend right=5mm] (d4);
      \path [-latex, dashed, example!65]   (d5) edge[bend left=5mm]  (d7);
      \path [-latex, dashed, example!65]   (d5) edge                 (d7);
      \path [-latex, dashed, example!65]   (d5) edge[bend right=5mm] (d7);

      \node  at (2.5,1.75) {OU};

      \node[smCloud, fill=structure!12]  (d3) at (1.5,1.0) {};
      \node[smCloud, fill=example!12]    (d6) at (4.0,1.0) {};

      \smState [\smInitial \smStructure] (d2) at (0.5,1.0) {$u_0$};
      \node [state, fill=alert!20, rectangle, rounded corners=3mm, text width=13mm, anchor=mid, align=center] (d4) at (2.75,1.0) {$u_f = v_0$};
      \smState [\smAccepting \smExample] (d7) at (4.5,1.0) {$v_f$};
      
      \path [-latex, dashed, structure!65] (d2) edge[bend left=5mm]  (d4);
      \path [-latex, dashed, structure!65] (d2) edge                 (d4);
      \path [-latex, dashed, structure!65] (d2) edge[bend right=5mm] (d4);
      \path [-latex, dashed, example!65]   (d4) edge[bend left=5mm]  (d7);
      \path [-latex, dashed, example!65]   (d4) edge                 (d7);
      \path [-latex, dashed, example!65]   (d4) edge[bend right=5mm] (d7);
    \end{tikzpicture}
  }

  \tf<6-|handout>[y=-32mm, x=5mm, anchor=west]{\footnotesize
    \begin{tikzpicture}[smAutomaton]
      \node[smCloud, fill=structure!12]  (e3) at (2.0,1.0) {};
      \smState[\smInitial   \smAlert]    (e1) at (0.0,1.5) {$q_0$};
      \smState[\smStructure         ]    (e2) at (1.0,1.0) {$u_0$};
      \smState[\smStructure         ]    (e4) at (2.5,1.0) {$u_f$};
      \smState[\smAccepting \smAlert]    (e5) at (0.0,0.5) {$q_f$};
      
      \smPath[\smAlert] (e1) edge                 node {$\varepsilon$} (e2);
      \smPath[\smAlert] (e2) edge                 node {$\varepsilon$} (e5);
      \smPath[\smAlert] (e4) edge[bend left=15mm] node {$\varepsilon$} (e2);

      \path[-latex, dashed, structure!65] (e2) edge[bend left=5mm]  (e4);
      \path[-latex, dashed, structure!65] (e2) edge                 (e4);
      \path[-latex, dashed, structure!65] (e2) edge[bend right=5mm] (e4);
    \end{tikzpicture}
  }
  
\end{frame}

\endgroup
